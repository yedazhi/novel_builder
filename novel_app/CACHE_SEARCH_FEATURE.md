# 缓存内容搜索功能

## 功能概述

新增的缓存内容搜索功能允许用户在已缓存的小说内容中进行全文搜索，快速定位相关章节和内容。

## 功能特性

### 1. 全文搜索
- 支持在章节标题和内容中搜索关键字
- 智能匹配，不区分大小写
- 提供匹配文本片段预览

### 2. 搜索范围筛选
- 可选择在所有已缓存小说中搜索
- 可选择在特定小说中搜索
- 自动显示已缓存小说列表

### 3. 搜索结果展示
- 显示匹配的章节标题和索引
- 提供匹配内容的文本片段（200字符上下文）
- 显示缓存时间信息
- 支持分页加载搜索结果

### 4. 用户界面
- 现代化的搜索界面设计
- 实时搜索状态反馈
- 无限滚动加载更多结果
- 响应式布局适配不同屏幕

## 使用方法

### 访问缓存搜索
1. 打开应用，进入底部导航的"搜索"标签
2. 点击右上角的存储图标（📦）
3. 进入缓存内容搜索界面

### 执行搜索
1. 在搜索框中输入要搜索的关键字
2. 可选择搜索范围：
   - 所有已缓存小说（默认）
   - 特定小说
3. 点击搜索按钮或按回车键
4. 查看搜索结果

### 查看搜索结果
- 搜索结果按小说和章节顺序排列
- 每个结果显示：
  - 章节标题
  - 章节索引（第X章）
  - 匹配的文本片段
  - 缓存时间
- 点击任意结果可跳转到对应的章节列表

## 技术实现

### 新增文件

1. **`lib/models/search_result.dart`**
   - `ChapterSearchResult`: 章节搜索结果模型
   - `CachedNovelInfo`: 已缓存小说信息模型

2. **`lib/services/cache_search_service.dart`**
   - `CacheSearchService`: 缓存搜索服务类
   - `CacheSearchResult`: 搜索结果包装类

3. **`lib/screens/cache_search_screen.dart`**
   - `CacheSearchScreen`: 缓存搜索界面

### 修改的文件

1. **`lib/services/database_service.dart`**
   - 添加 `searchInCachedContent()` 方法
   - 添加 `getCachedNovels()` 方法
   - 添加 `_extractMatchedText()` 私有方法

2. **`lib/screens/search_screen.dart`**
   - 在AppBar添加缓存搜索入口按钮
   - 添加 `_checkHasCachedContent()` 方法

### 数据库查询

搜索功能使用SQLite的LIKE操作符进行模糊匹配：

```sql
SELECT * FROM chapter_cache
WHERE content LIKE ? OR title LIKE ?
ORDER BY novelUrl, chapterIndex
```

### 性能优化

1. **分页加载**: 每页20个结果，避免一次性加载过多数据
2. **索引利用**: 利用现有的索引提高查询性能
3. **文本截取**: 只提取匹配文本的上下文片段
4. **异步处理**: 所有数据库操作都是异步的

## 搜索算法

### 文本匹配算法
1. 在章节内容中查找关键字（不区分大小写）
2. 提取匹配位置前后各100个字符作为上下文
3. 如果匹配位置在开头或结尾，自动调整片段长度
4. 添加省略号表示文本被截断

### 结果排序
- 按小说URL分组
- 按章节索引升序排列
- 保持阅读顺序的一致性

## 错误处理

1. **无缓存内容**: 显示友好的提示界面
2. **搜索失败**: 提供重试按钮
3. **空结果**: 提供搜索建议
4. **网络错误**: 本地搜索，不受网络影响

## 用户体验优化

1. **即时反馈**: 搜索状态实时显示
2. **智能提示**: 提供搜索建议和筛选选项
3. **便捷导航**: 一键跳转到匹配章节
4. **历史记录**: 记住用户的搜索偏好

## 未来改进方向

1. **高亮显示**: 在章节内容中高亮匹配的关键字
2. **搜索历史**: 保存用户的搜索历史
3. **高级搜索**: 支持多关键字、排除词等
4. **搜索统计**: 显示搜索频率和热门关键词
5. **性能监控**: 监控搜索性能和优化建议

## 使用注意事项

1. **缓存依赖**: 需要先缓存小说内容才能搜索
2. **搜索范围**: 只能搜索已缓存的内容，无法搜索网络内容
3. **文本编码**: 支持中文和其他Unicode字符
4. **性能考虑**: 大量缓存内容时搜索可能需要较长时间

## 兼容性

- **Flutter版本**: 兼容 Flutter 3.0+
- **平台支持**: Android, iOS
- **数据库**: SQLite
- **最低要求**: 需要至少有一章缓存内容