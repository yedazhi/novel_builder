# 章节重排功能说明

## 功能概述

章节重排功能允许用户通过拖拽的方式重新排序小说章节，调整章节的阅读顺序。重排完成后，系统会自动更新数据库中的章节索引，确保新的顺序得以保存。

## 使用方法

### 1. 进入重排模式
- **长按任意章节**：在章节列表页面长按任意章节即可进入重排模式
- **点击重排按钮**：点击AppBar中的重排图标（`⠿`）也可以进入重排模式

### 2. 执行重排操作
- 进入重排模式后，章节列表会显示不同的UI样式：
  - 每个章节左侧显示拖拽手柄（`⋮⋮`）
  - 章节左侧显示序号标签（橙色背景）
  - 章节项显示橙色边框
  - 用户章节保持蓝色标识
- **拖拽操作**：按住拖拽手柄可以上下拖拽章节到新位置

### 3. 退出重排模式
- **点击完成按钮**：点击AppBar中的绿色完成按钮（`✓`）
- **自动保存**：每次拖拽完成后系统会自动保存新的章节顺序

## 功能特性

### UI特性
1. **双模式列表显示**：
   - 正常模式：显示插入、删除、缓存等功能按钮
   - 重排模式：显示拖拽手柄和序号标签

2. **视觉反馈**：
   - 重排模式：橙色主题标识
   - 用户章节：保持蓝色标识不变
   - 拖拽过程：实时显示拖拽效果

3. **用户提示**：
   - 进入重排模式：显示"已进入重排模式，拖拽章节调整顺序"
   - 保存中：显示"正在保存章节顺序..."
   - 保存成功：显示"章节顺序已保存"
   - 保存失败：显示具体错误信息

### 数据处理
1. **索引重新计算**：
   - 重排后所有章节的`chapterIndex`从0开始重新连续分配
   - 同时更新`novel_chapters`和`chapter_cache`两个表

2. **数据一致性**：
   - 使用数据库事务确保数据一致性
   - 保存完成后重新加载章节列表

3. **性能优化**：
   - 使用批量更新操作减少数据库访问次数
   - 异步保存避免阻塞UI线程

## 技术实现

### 核心组件
1. **ReorderableListView**：Flutter提供的可重排列表组件
2. **数据库操作**：`updateChaptersOrder`方法批量更新章节索引
3. **状态管理**：`_isReorderingMode`状态控制UI显示

### 关键方法
- `_toggleReorderingMode()`：切换重排模式
- `_onReorder(int oldIndex, int newIndex)`：处理重排操作
- `_saveReorderedChapters()`：保存重排后的章节顺序

## 使用场景

1. **调整章节顺序**：用户可以根据喜好调整章节阅读顺序
2. **修复章节乱序**：当章节获取顺序不正确时可以手动调整
3. **个性化阅读**：用户可以将喜欢的章节调整到前面

## 注意事项

1. **网络章节**：重新获取章节列表时，用户自定义的章节顺序会保留，但网络章节会重新按顺序排列
2. **用户章节**：用户创建的章节在重排中会保持特殊标识（蓝色边框）
3. **数据备份**：建议在大量重排操作前备份重要数据

## 未来改进

1. **批量选择**：支持选择多个章节进行批量移动
2. **撤销重做**：支持撤销和重做重排操作
3. **章节分组**：支持将章节分组管理
4. **导入导出**：支持章节顺序的导入导出功能