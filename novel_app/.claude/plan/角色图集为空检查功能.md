# 角色图集为空检查功能

## 任务描述
在角色卡编辑页面，如果角色的图集是空的时候，点击头像的时候提示【角色图集为空，请先生成图集后再点击】

## 上下文
- **项目**: Novel Builder Flutter移动应用
- **文件**: `lib/screens/character_edit_screen.dart`
- **方法**: `_openGallery()` 方法
- **目标用户**: 在角色编辑页面的用户
- **需求**: 防止用户点击头像进入空图集页面

## 计划概述
采用方案1：在现有_openGallery方法中添加图集检查逻辑

## 执行步骤

### 1. 分析现有代码结构 ✅
- **文件**: `lib/screens/character_edit_screen.dart:980-1018`
- **发现**: _openGallery方法当前只检查角色ID是否存在，然后直接跳转到图集页面
- **修改位置**: 在角色ID检查之后，跳转之前添加图集为空检查

### 2. 添加必要依赖 ✅
- **导入**: `package:novel_api/novel_api.dart`
- **别名**: `import '../models/novel.dart' as local_novel;` (解决命名冲突)
- **移除**: 未使用的导入和字段

### 3. 实现图集检查方法 ✅
```dart
/// 检查角色图集是否为空
/// 返回true表示图集为空，false表示图集不为空
Future<bool> _checkGalleryEmpty(String characterId) async {
  try {
    // 使用API获取角色图集信息
    final host = await _apiService.getHost();
    final api = NovelApi(basePathOverride: host).getDefaultApi();
    final response = await api.getRoleCardGalleryApiRoleCardGalleryRoleIdGet(roleId: characterId);

    if (response.statusCode == 200 && response.data != null) {
      final gallery = response.data!;
      return gallery.images.isEmpty;
    } else {
      // 如果获取失败，假设图集为空
      debugPrint('❌ 获取角色图集失败: ${response.statusCode}');
      return true;
    }
  } catch (e) {
    debugPrint('❌ 检查图集状态异常: $e');
    // 如果发生异常，假设图集为空，避免用户进入空页面
    return true;
  }
}
```

### 4. 实现提示对话框方法 ✅
```dart
/// 显示图集为空的对话框
Future<void> _showEmptyGalleryDialog() async {
  if (!mounted) return;

  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => AlertDialog(
      title: const Text('提示'),
      content: const Text('角色图集为空，请先生成图集后再点击'),
      actions: [
        TextButton(
          onPressed: () {
            Navigator.of(context).pop();
          },
          child: const Text('确定'),
        ),
      ],
    ),
  );
}
```

### 5. 修改_openGallery方法逻辑 ✅
```dart
/// 打开图集管理页面
Future<void> _openGallery() async {
  if (widget.character?.id == null) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('请先保存角色后再管理图集'),
          backgroundColor: Colors.orange,
        ),
      );
    }
    return;
  }

  // 检查图集是否为空
  final isEmpty = await _checkGalleryEmpty(widget.character!.id!.toString());
  if (isEmpty) {
    await _showEmptyGalleryDialog();
    return;
  }

  if (!mounted) return;

  try {
    final result = await Navigator.push<bool>(
      context,
      MaterialPageRoute(
        builder: (context) => GalleryViewScreen(
          roleId: widget.character!.id!.toString(),
          roleName: widget.character!.name,
        ),
      ),
    );

    // 如果图集页面返回true，说明头像已更新，需要重新加载数据
    if (result == true && mounted) {
      await _refreshCharacterData();
    }
  } catch (e) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('打开图集失败: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }
}
```

## 使用方法
- **触发条件**: 用户在角色编辑页面点击头像
- **检查逻辑**: 通过API获取角色图集，检查图片列表是否为空
- **提示方式**: AlertDialog模态对话框
- **用户操作**: 点击"确定"关闭对话框
- **阻止行为**: 阻止用户进入空图集页面

## API调用
- **方法**: `getRoleCardGalleryApiRoleCardGalleryRoleIdGet`
- **参数**: `roleId: characterId`
- **返回**: `RoleGalleryResponse` 包含 `images` 列表
- **判断逻辑**: `gallery.images.isEmpty`

## 测试场景
1. **角色ID为null**: 显示原有提示"请先保存角色后再管理图集"
2. **图集为空**: 显示新提示"角色图集为空，请先生成图集后再点击"
3. **图集不为空**: 正常跳转到图集管理页面
4. **API调用失败**: 假设图集为空，显示提示对话框
5. **网络异常**: 假设图集为空，显示提示对话框

## 代码质量
- ✅ 通过 `flutter analyze` 检查，无语法错误
- ✅ 添加了 `mounted` 检查避免 BuildContext 跨异步使用
- ✅ 使用了适当的异常处理
- ✅ 保持了原有代码风格和结构
- ✅ 移除了未使用的导入和字段

## 用户体验
- **直观**: 使用AlertDialog明确提示用户问题
- **友好**: 提示信息清晰说明问题和解决方案
- **安全**: 防止用户进入空白页面
- **一致性**: 与项目现有的UI风格保持一致