# 更新角色卡功能 - 执行计划

## 任务概述
- **目标**：在文章阅读界面实现【更新角色卡】功能，智能分析章节内容并更新角色信息
- **方案**：基于现有AI生成角色流程的扩展方案，最大化代码复用
- **范围**：ReaderScreen菜单集成、Dify服务扩展、角色去重更新逻辑

## 上下文信息
- **技术栈**：Flutter 3.0+，Dart SDK，Dify AI集成
- **项目类型**：小说阅读移动应用
- **核心依赖**：CharacterPreviewDialog, DifyService, DatabaseService

## 详细实施步骤

### 步骤1：创建角色名称匹配工具类
**文件**：`lib/utils/character_matcher.dart`
- 创建章节内容中角色名称识别功能
- 提供Dify参数格式化方法
- 实现角色匹配和数据准备逻辑

### 步骤2：扩展DifyService角色更新功能
**文件**：`lib/services/dify_service.dart`
- 新增 `updateCharacterCards()` 方法
- 复用现有runWorkflowBlocking和解析逻辑
- 使用正确的Dify参数结构（chapters_content, roles）

### 步骤3：扩展数据库服务角色去重更新功能
**文件**：`lib/services/database_service.dart`
- 新增角色去重和更新方法
- 实现基于名称的匹配逻辑
- 支持批量角色更新操作

### 步骤4：ReaderScreen菜单集成
**文件**：`lib/screens/reader_screen.dart`
- 在PopupMenuButton中添加"更新角色卡"菜单项
- 实现 `_updateCharacterCards()` 处理方法
- 集成完整的角色更新流程

### 步骤5：角色更新流程集成
- 数据准备：获取章节内容和现有角色
- 角色分析：识别章节中出现的角色
- Dify调用：智能分析和生成角色信息
- 结果展示：使用CharacterPreviewDialog
- 确认更新：执行数据库去重更新

### 步骤6：错误处理和用户体验优化
- 完善的错误处理机制
- 加载提示和进度指示
- 用户反馈和确认流程

## 关键技术细节

### Dify API参数结构
```dart
final inputs = {
  'chapters_content': chaptersContent,  // 当前章节内容
  'roles': roles,                        // 现有角色信息（AI格式）
  'cmd': 'update_characters',           // 新的命令类型
  'ai_writer_setting': aiWriterSetting,
  'background_setting': backgroundSetting,
};
```

### 角色去重更新逻辑
- 按 `name + novelUrl` 组合匹配角色
- 存在时：保留原有ID和创建时间，更新其他字段
- 不存在时：创建全新角色记录

### 用户交互流程
1. 用户点击右上角菜单 → "更新角色卡"
2. 系统分析当前章节内容，识别已有角色
3. 调用Dify AI服务分析并生成角色信息
4. 展示CharacterPreviewDialog供用户确认
5. 执行角色去重更新（同名的旧角色被新角色信息替换）

## 预期影响
- **修改文件数量**：4个文件（1个新建，3个修改）
- **新增代码行数**：约200-300行
- **用户体验提升**：智能角色信息管理，减少手动编辑
- **功能完整性**：完善AI驱动的角色管理生态系统

## 风险控制
- **复用现有代码**：最大化使用已验证的AI生成角色功能
- **渐进式开发**：分步骤实现，每步都可独立测试
- **向后兼容**：不影响现有角色管理功能
- **错误隔离**：新功能异常不会影响核心阅读功能